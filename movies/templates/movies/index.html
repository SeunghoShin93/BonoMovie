{% extends 'movies/base.html' %}

{% block content %}

<h1>Main Page</h1>
{% if user.is_authenticated and like_movie.count > 0 %}
  <ul>
  좋아하신 영화: '<b>{{ selected_movie }}</b>'의 장르
  '<b>{{ selected_genre }}</b>'를 기반으로 추천된 영화들:
  <hr>
  <ul>
  {% for select in selected_movies %}
  <li>{{select.title}}</li>
  {% endfor %}
 </ul>
 {% endif %}
<hr>
  {% for genre in all_genres %}
  <a href="{% url 'movies:genre_movie_list' genre.pk %}">{{ genre }}</a>
  {% endfor %}
  {% for movie in movies %}
  <li><a href="{% url 'movies:detail' movie.pk %}">{{ movie.title }}</a>
    {{ movie.popularity }}
    
      {% if user in movie.like_users.all %}
 
      <i class="fas fa-heart like-button" style="font-size: 20px; color: crimson;" data-id="{{ movie.pk }}"></i>
      {% else %}
  
      <i class="far fa-heart like-button" style="font-size: 20px; color: black;" data-id="{{ movie.pk }}"></i>
      {% endif %}
      <span id="like-count-{{ movie.pk }}">{{ movie.like_users.count }}</span> 명이 이 글을 좋아합니다.
  </li>
  {% endfor %}
</ul>
<script>
  const likeButtons = document.querySelectorAll('.like-button')
  likeButtons.forEach(button => {
    button.addEventListener('click', function (event) {
      console.log(event)
      const movieId = event.target.dataset.id
      axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFToken'
      axios.post(`/movies/${movieId}/like/`)
        .then(response => {
          console.log(response)
          document.querySelector(`#like-count-${movieId}`).innerText = response.data.count
          if (response.data.liked) {
            event.target.style.color = 'crimson'
            event.target.className = 'fas fa-heart like-button' 
          } else {
            event.target.style.color = 'black'
            
            event.target.className = 'far fa-heart like-button' 
          }
          })
            .catch(error => console.log(error))
    })
  })
</script>

{% endblock content %}